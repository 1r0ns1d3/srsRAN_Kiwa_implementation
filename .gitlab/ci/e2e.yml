#
# Copyright 2013-2023 Software Radio Systems Limited
#
# By using this file, you agree to the terms and conditions set
# forth in the LICENSE file which can be found at the top level of
# the distribution.
#

.prepare_test:
  before_script:
    - |
      export FORCE_COLOR=1
      export KUBECONFIG=$KUBE_CONFIG
      kubectl config set current-context kubernetes-admin@srs-k8s-lab

.e2e-run:
  stage: e2e
  timeout: 8h
  interruptible: false
  image:
    name: registry.gitlab.com/softwareradiosystems/retina/launcher/3.11-alpine:0.0.14
    entrypoint: ["/bin/sh", "-c"]
  variables:
    REQUEST: "" # Retina YAML request
    LOG_LEVEL: ""
    MARKERS: ""
    ARGS: ""
    FORCE_DOWNLOAD: ""
  tags:
    - on-prem-amd64
  extends:
    - .prepare_test
  rules:
    - if: $CI_DESCRIPTION =~ /Nightly/
  artifacts:
    paths:
      - $CI_JOB_NAME/*
    when: always
    reports:
      junit: tests/e2e/out.xml
  script:
    - |
      cd tests/e2e
      export LOGNAME=$GITLAB_USER_LOGIN
      export RETINA_LOGLEVEL="$LOG_LEVEL"
      export FORCE_DOWNLOAD="$FORCE_DOWNLOAD"

    - retina-launcher --retina-request ${REQUEST} --self-contained-html --html=./log/report.html --junitxml=out.xml "${ARGS}" -m "${MARKERS}" .
  after_script:
    - |
      echo "**************************************************************************************"
      echo "Test report ---> https://softwareradiosystems.gitlab.io/-/$CI_PROJECT_NAME/-/jobs/$CI_JOB_ID/artifacts/$CI_JOB_NAME/report.html"
      echo "**************************************************************************************"
    - mv tests/e2e/log ${CI_PROJECT_DIR}/$CI_JOB_NAME
    - echo "$CI_JOB_ID" >> ${CI_PROJECT_DIR}/$CI_JOB_NAME/job.env

################################################################################
## e2e build
################################################################################
e2e-build:
  extends: .build_and_unit_big
  stage: e2e
  tags:
    - ${SRS_INFRASTRUCTURE_TAG}-${PLATFORM}
  variables:
    OS: ubuntu-22.04
    TEST_MODE: none
    PLATFORM: "amd64"
    AUTO_DETECT_ISA: "False"
    ENABLE_TSAN: "False"
    COMPILER: gcc
    BUILD_TYPE: Debug
    ASSERT_LEVEL: PARANOID
  needs: []
  rules:
    - if: $ON_MR
    - if: $CI_DESCRIPTION =~ /Nightly/
  after_script:
    - echo "Empty after script"
  artifacts:
    name: "srsgnb_bin"
    paths:
      - build/apps/gnb/gnb
  cache: []

################################################################################
## e2e tests
################################################################################
zmq:
  extends: .e2e-run
  variables:
    REQUEST: "${CI_PROJECT_DIR}/.gitlab/ci/retina_request_zmq.yml"
    MARKERS: "smoke and not tcp"
    LOG_LEVEL: "debug"
    ARGS: "-x"
    FORCE_DOWNLOAD: "false"
  rules:
    - if: $ON_MR
      # when: manual
      # allow_failure: false
    # - if: $ON_MR == "true" && $GITLAB_USER_NAME == $CODEBOT_USERNAME
    - if: $CI_DESCRIPTION =~ /Nightly/
      variables:
        MARKERS: "zmq"
        LOG_LEVEL: "warning"
        ARGS: ""
        FORCE_DOWNLOAD: "true"
  needs:
    - job: "e2e-build"
      artifacts: true

rf:
  extends: .e2e-run
  variables:
    REQUEST: "${CI_PROJECT_DIR}/.gitlab/ci/retina_request_rf.yml"
    LOG_LEVEL: "warning"
    MARKERS: "rf and not tcp"
    FORCE_DOWNLOAD: "true"
  rules:
    - if: $CI_DESCRIPTION =~ /Nightly/
  needs:
    - job: "e2e-build"
      artifacts: true