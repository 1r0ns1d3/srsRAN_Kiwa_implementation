include:
  - project: softwareradiosystems/testing-tools
    ref: "20"
    file: .gitlab/ci-shared/setup/all.yml
  - project: softwareradiosystems/testing-tools
    ref: "20"
    file: .gitlab/ci-shared/features/all.yml
  - local: .gitlab/ci/build.yml

stages:
  - ci
  - static
  - build
  - tests
  - documentation

################################################################################
## Static
################################################################################
include-guards:
  extends: .include-guards
  parallel:
    matrix:
      - INPUT_PATH: "include/srsgnb"
        INPUT_IGNORE: "/bundled/"
      - INPUT_PATH: "."
        INPUT_IGNORE: "^\\(include\\|docs\\)/.*"

################################################################################
## Build + Unit Tests + Integration tests
################################################################################
cmake flag check:
  stage: build
  extends: .build_and_unit
  rules:
    - if: $ON_MR
    - if: $ON_SCHEDULE
  script:
    - CC=/usr/bin/gcc
    - CXX=/usr/bin/g++
    - mkdir build && cd build && cmake -G Ninja ${flag} ..
  parallel:
    matrix:
      - flag:
          [-DSTOP_ON_WARNING=True, -DENABLE_EXPORT=True, -DBUILD_TESTS=False]
  needs: []

intermediate commits:
  extends: .build
  rules:
    - if: $ON_MR
  script:
    - DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y --no-install-recommends git git-lfs
    - git lfs install
    - git config advice.detachedHead false
    - git fetch origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
    - |
      for rev in $(git rev-list --reverse origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME..origin/$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME^1)
      do
        echo "##################################################"
        echo "#### $rev ####"
        echo "##################################################"
        git checkout $rev
        build_srsgnb
      done
  after_script:
    - rm -Rf build

.trigger build:
  stage: build
  trigger:
    include: .gitlab/ci/build.yml
    strategy: depend
  variables:
    mode: default
  needs: []

alt:
  extends: .trigger build
  rules:
    - if: $ON_MR
      variables:
        run_tests: "false"
    - if: $ON_SCHEDULE
  parallel:
    matrix:
      - os_type: ubuntu
        os_version: "22.04"
        compiler: clang
        uhd_version: "4.1.0.5"
      - os_type: ubuntu
        os_version: "20.04"
        uhd_version: "3.15.0.0"
        compiler: [gcc, clang]
      - os_type: archlinux
        os_version: latest
        uhd_version: "4.2.0.0"
        compiler: [gcc, clang]

sanitizers [tsan]:
  extends: .trigger build
  rules:
    - if: $ON_SCHEDULE
  variables:
    compiler: clang
    mode: tsan
    CI_MERGE_REQUEST_LABELS: no-cache

sanitizers [asan]:
  extends: .trigger build
  rules:
    - if: $ON_SCHEDULE
  variables:
    compiler: gcc
    mode: asan
    CI_MERGE_REQUEST_LABELS: no-cache

sanitizers [valgrind]:
  extends: .trigger build
  rules:
    - if: $ON_SCHEDULE
  variables:
    compiler: gcc
    mode: valgrind
    CI_MERGE_REQUEST_LABELS: no-cache

alt uhd:
  extends: .trigger build
  rules:
    - if: $ON_SCHEDULE
      variables:
        CI_MERGE_REQUEST_LABELS: no-cache
  parallel:
    matrix:
      - os_type: ubuntu
        os_version: "22.04"
        compiler: [gcc, clang]
        uhd_version: "4.2.0.0"
      - os_type: ubuntu
        os_version: "20.04"
        compiler: [gcc, clang]
        uhd_version: ["4.2.0.0", "4.1.0.5"]

################################################################################
# Doc generation
################################################################################
.depends on unit test jobs:
  # Here we handled how jobs in .gitlab-ci.yml depends on jobs inside build.yml
  # If unit tests related jobs change in build.yml, we'll need to change this one too
  needs:
    - job: unit tests
      artifacts: true

unit requirements:
  stage: documentation
  rules:
    - if: $ON_SCHEDULE
      when: always # Even if previous stages/required jobs fail
  image: registry.gitlab.com/softwareradiosystems/testing-tools/srs-tools:$SRS_TOOLS_VERSION
  script:
    - test-reporter --input unittests --output ./requirement_report.html
  needs: []
  artifacts:
    paths:
      - requirement_report.html
    expire_in: 10 minutes

unit coverage:
  stage: documentation
  extends: .depends on unit test jobs
  image:
    name: registry.gitlab.com/softwareradiosystems/testing-tools/report_generator:$DOCKER_REPORT_GEN_VERSION
    entrypoint: ["/bin/sh", "-c"]
  rules:
    - if: $ON_MR
      variables:
        coverage_report: summary
      when: always # Even if previous stages/required jobs fail
    - if: $ON_SCHEDULE
      variables:
        coverage_report: full
      when: always # Even if previous stages/required jobs fail
  before_script:
    - PACKAGE_URL=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/coverage/${CI_COMMIT_BRANCH}${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}/coverage_history.tar.gz
    # Download coverage history from the registry
    - |
      download_from_registry() {
        apk add --update curl
        
        cd ${CI_PROJECT_DIR}
        http_code=$(curl -w "%{http_code}" --header "PRIVATE-TOKEN: $CODEBOT_TOKEN" "${PACKAGE_URL}" -o output.tar.gz)
        if [[ $http_code == "200" ]]; then
          tar -xf output.tar.gz
        fi
      }
    # Publish coverage history folder to the registry
    - |
      publish_to_registry() {
        cd ${CI_PROJECT_DIR}
        tar -czf coverage_history.tar.gz coverage_history
        curl --fail --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file coverage_history.tar.gz "${PACKAGE_URL}"
      }
  script:
    - |
      if [[ $coverage_report = "full" ]]; then
        download_from_registry
        HTML_TYPE=Html
        HISTORY=-historydir:coverage_history
      else
        HTML_TYPE=HtmlSummary
        HISTORY=
      fi
    - |
      ReportGenerator -reports:*coverage.xml -targetdir:coverage_html ${HISTORY} \
        -title:${CI_PROJECT_NAME} -tag:${CI_COMMIT_SHA} \
        -reporttypes:"${HTML_TYPE};TextSummary"
    - cat coverage_html/Summary.txt
    - |
      if [[ $coverage_report = "full" ]]; then
        publish_to_registry
      fi
  coverage: /^\s*Line coverage:\s*\d+.\d+\%/
  artifacts:
    paths:
      - coverage_html
    expire_in: 10 minutes

unit tests web:
  stage: documentation
  extends: .depends on unit test jobs
  rules:
    - if: $ON_SCHEDULE
      when: always # Even if previous stages/required jobs fail
  image: python:3.9-alpine # sh entrypoint
  variables:
    GIT_STRATEGY: none
  before_script:
    - pip install junit2html
  script:
    - junit2html *xunit.xml --merge merged_xunit.xml
    - junit2html merged_xunit.xml ./test_report.html
  artifacts:
    paths:
      - test_report.html
    expire_in: 10 minutes

pages:
  stage: documentation
  rules:
    - if: $ON_SCHEDULE
      when: always # Even if previous stages/required jobs fail
  image: registry.gitlab.com/softwareradiosystems/testing-tools/doxygen:$DOCKER_DOXYGEN_VERSION
  script:
    - doxygen_generator.sh
    - mv build/public .
    - mv coverage_html public/
    - mv test_report.html public/
    - mv requirement_report.html public/
    - mv public/index.html public/index_doxygen.html
    - mv docs/index.html public/index.html
  after_script:
    - |
      if [ $CI_JOB_STATUS = "failed" ]; then
        mkdir -p public
        mv docs/fail.html public/index.html
      fi
    - mv docs/*.png public/
    - sed -i 's/commit_hash/'$CI_COMMIT_SHA'/' public/index.html
  needs:
    - job: unit coverage
      artifacts: true
    - job: unit requirements
      artifacts: true
    - job: unit tests web
      artifacts: true
  artifacts:
    paths:
      - public
    expire_in: 10 minutes
